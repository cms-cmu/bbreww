workflow:
  rules:
    # Do not run if only markdown files changed
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH'
      changes:
        - "**/*.md"
      when: never
    # Do not run for tags
    - if: '$CI_COMMIT_TAG'
      when: never
    # Do not run for branches with 'test' in the name
    - if: '$CI_COMMIT_BRANCH =~ /test/'
      when: never
    # Run for merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    # Run for pushes to branches WITHOUT open merge requests
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS == null'
      when: always
    # Run for scheduled pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    # Run for web-triggered pipelines
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always

variables:
  BARISTA_REPO: 'https://${DEPLOY_TOKEN_USERNAME}:${DEPLOY_TOKEN_PASSWORD}@gitlab.cern.ch/cms-cmu/barista.git'
  BARISTA_BRANCH: '$CI_COMMIT_REF_NAME'

include:
  - local: workflows/gitlab-CI/analysis.yml
  - local: workflows/gitlab-CI/cutflows.yml
  - local: workflows/gitlab-CI/plot.yml
  - local: workflows/gitlab-CI/skimmer.yml
  - project: 'cms-cmu/barista'
    ref: '$CI_COMMIT_REF_NAME'
    file: 'src/workflows/gitlab-CI/stages_proxy.yml'

stages:  
  - setup
  - skimmer
  - analysis
  - plot
  - cutflow

# Setup job that clones barista once
setup_workspace:
  stage: setup
  image: alpine/git:latest
  script:
    - echo "Setting up barista workspace"
    # --- Add fallback logic for cloning barista ---
    - BARISTA_DEFAULT_BRANCH="master" 
    - echo "Checking for branch '$BARISTA_BRANCH' in barista repository..."
    # Check if the feature branch exists in barista. If not, use the default branch.
    - git ls-remote --exit-code --heads "$BARISTA_REPO" "$BARISTA_BRANCH" || BARISTA_BRANCH="$BARISTA_DEFAULT_BRANCH"
    
    - echo "Cloning barista from branch '$BARISTA_BRANCH'"
    - git clone --recursive --depth=1 --branch=$BARISTA_BRANCH $BARISTA_REPO barista_framework
    - cd barista_framework

    # Create the subdirectory for the current project and copy its content
    # For bbreww repository, use 'bbreww'. For coffea4bees, use 'coffea4bees'.
    - mkdir -p bbreww 
    - echo "Copying content of $CI_PROJECT_NAME into barista_framework/bbreww/"
    - cp -r $CI_PROJECT_DIR/* bbreww/ 2>/dev/null || true
    - ls -la bbreww/
  artifacts:
    paths:
      - barista_framework/
    expire_in: 2 hours
  tags:
    - k8s-cvmfs

# Base template for all jobs that need the framework
.base_analysis:
  needs:
    - setup_workspace
    - voms_proxy
  before_script:
    - cp -r proxy/ barista_framework/
    - cd barista_framework/
    - pwd && ls -la
    - ls -la bbreww/
  image: gitlab-registry.cern.ch/cms-cmu/barista:latest
  tags:
    - k8s-cvmfs
